
<!DOCTYPE html>
<html>
<head>
	<title>NZ COVID-19 cases over time</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js" integrity="sha256-rVeyUZMfAHhQJ7hvWaHrKknTDdqGcn1gxBBJA++E4z8=" crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.23.0/moment.min.js"></script>
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.3/chroma.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/resizerjs"></script>
    <style>
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .row {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #map, #plots {
            flex: auto;
            width: 0;
        }
        .plot {
            display: inline-block;
        }

        #title {
            flex: auto;
            margin: 0;
            text-align: center;
            color: white;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            font-size: 1rem;
            font-family: Arial, Helvetica, sans-serif;
            text-shadow: 2px 2px #000000;
            font-weight: normal;
        }

        .leaflet-tooltip-pane .text {
            color: black; 
            font-weight: bold;
            background: transparent;
            border:0;
            box-shadow: none;
            font-size:1em;
        }

        [data-rz-handle] {
            flex: 0 0 6px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        [data-rz-handle] div {
            width: 6px;
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>

</head>
<body>

<h1 id="title">NZ COVID-19 cases over time</h1>
<div class="row">
    <div id="map"></div>
    <div id="plots">
        <div id="timeline" class="plot" style="width: 100%"></div>
        <div id="gender" class="plot" style="width: 50%"></div>
        <div id="age" class="plot" style="width: 50%;float: right"></div>
    </div>
</div>
<script>

    const myResizer = new Resizer('.row');

    var map = L.map('map', {
        center: [-41.235726,172.5118422],
        zoom: 6,
        minZoom: 5,
        maxZoom: 13
    });

    var bounds = map.getBounds();
    var degreeLimit = 10;
    bounds._northEast.lat += degreeLimit;
    bounds._northEast.lng += degreeLimit;
    bounds._southWest.lat -= degreeLimit;
    bounds._southWest.lng -= degreeLimit;
    map.setMaxBounds(bounds);

    var baseMaps = {
        "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
        "OSM Grayscale": L.tileLayer.provider("OpenStreetMap.BlackAndWhite"),
        "CartoDB Positron": L.tileLayer.provider('CartoDB.Positron').addTo(map),
        "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
        "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
        "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }),
        "Wikimedia": L.tileLayer.provider("Wikimedia")
    }

    var regionCounts = L.layerGroup().addTo(map);

    var overlayMaps = {
        "Region counts": regionCounts
    }

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    var cmap = chroma.scale([chroma.hsv(0, 1, 1), chroma.hsv(90, 1, 1), chroma.hsv(180, 1, 1), chroma.hsv(270, 1, 1)]).mode("hsv").domain([10, 1]);

    // from 28th feb
    var casesPerDay = [1,1,1,1,1,1,3,3,4,5,5,5,5,5,5,5,6,8,8,12,20,28,39,52,66,102,155,205]
    var start = moment("2020-02-28");
    var dates = [start];
    for (var i = 0; i < casesPerDay.length; i++) {
        dates.push(start.clone().add(i, "days").toDate());
    }
    console.log(dates)

    var data = [{
        type: "scatter",
        mode: "lines",
        name: "Confirmed cases",
        x: dates,
        y: casesPerDay,
        line: {color: '#17BECF'}
    }];
    var layout = {
        title: "NZ COVID-19 cases over time",
        xaxis: {
            title: "Date"
        },
        yaxis: {
            title: "Cases",
        }
    };
    Plotly.newPlot("timeline", data, layout, {responsive: true});


    $.getJSON("https://nzcovid19api.xerra.nz/cases/json", function (data) {
        console.log(data)
        window.data = data;
        locationSummary = {}
        genderSummary = {
            "Male": 0,
            "Female": 0,
            "Unknown or undisclosed": 0
        }
        ages = []
        for (var i in data) {
            var c = data[i];
            if (c.LocationName == 'Waitemata') c.LocationName = "Auckland";
            if (c.LocationName == 'Southern DHB') c.LocationName = "Dunedin";
            c.LocationName = c.LocationName.replace(" Region", "")
            if (!locationSummary[c.LocationName]) {
                locationSummary[c.LocationName] = {
                    latlong: c.LocationCentrePoint.coordinates.reverse(),
                    name: c.LocationName,
                    count: 1
                }
            } else {
                locationSummary[c.LocationName].count++;
            }
            if (c.CaseType == "confirmed") {
                for (var i in casesPerDay) {
                    var n = casesPerDay[i];
                    if (c.CaseNumber <= n) {
                        c.Date = dates[i];
                        break;
                    }
                }
            }
            genderSummary[c.Gender]++;
            if (c.Age.Valid) {
                ages.push((c.Age.YoungerOrEqualToAge + c.Age.OlderOrEqualToAge) / 2)
            }
        }
        for (var i in locationSummary) {
            var l = locationSummary[i]
            var radius = l.count;
            if (radius < 10) radius = 10;
            var marker = L.circleMarker(l.latlong, { radius: radius, color: cmap(l.count) }).bindTooltip(l.name).addTo(map);
            var text = L.tooltip({
                permanent: true,
                direction: 'center',
                className: 'text'
            }).setContent("" + l.count).setLatLng(l.latlong).addTo(regionCounts);
        }

        var data = [{
            values: Object.values(genderSummary),
            labels: Object.keys(genderSummary),
            type: 'pie'
        }];

        var layout = {
            title: "Gender distribution"
        };

        Plotly.newPlot('gender', data, layout, {responsive: true});

        var data = [{
            x: ages,
            type: 'histogram',
            xbins: {
                end: 100, 
                size: 10, 
                start: 0
            }
        }];
        var layout = {
            title: "Age distribution",
        }
        Plotly.newPlot('age', data, layout, {responsive: true});
    });

</script>



</body>
</html>